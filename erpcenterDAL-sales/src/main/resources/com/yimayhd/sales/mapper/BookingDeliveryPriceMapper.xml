<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yimayhd.erpcenter.dal.sales.operation.dao.BookingDeliveryPriceMapper" >
  <resultMap id="BaseResultMap" type="com.yimayhd.erpcenter.dal.sales.client.operation.po.BookingDeliveryPrice" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="booking_id" property="bookingId" jdbcType="INTEGER" />
    <result column="item_name" property="itemName" jdbcType="VARCHAR" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="unit_price" property="unitPrice" jdbcType="DECIMAL" />
    <result column="sale_price" property="salePrice" jdbcType="DECIMAL" />
    <result column="num_times" property="numTimes" jdbcType="DECIMAL" />
    <result column="num_person" property="numPerson" jdbcType="DECIMAL" />
    <result column="total_price" property="totalPrice" jdbcType="DECIMAL" />
    <result column="row_state" property="rowState" jdbcType="TINYINT" />
    <result column="creator_id" property="creatorId" jdbcType="INTEGER" />
    <result column="creator_name" property="creatorName" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="BIGINT" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, booking_id, item_name, remark, unit_price, sale_price,num_times, num_person, total_price,
    row_state, creator_id, creator_name, create_time
  </sql>
  <select id="getSupplierPriceListPage" resultMap="BaseResultMap" parameterType="com.yihg.mybatis.utility.PageBean" >
    	SELECT 
			tg.group_code AS groupCode,
			tg.group_mode AS groupMode,
			tg.date_start as dateStart,
			tg.date_end as dateEnd,
			tg.id groupId,
			tg.create_time,
			tg.operator_name AS operatorName,
			tg.operator_id,
			bd.supplier_name as supplierName,
			tg.group_mode, 
			IFNULL(bd.person_adult,0) personAdult,
			IFNULL(bd.person_child,0) personChild,
			IFNULL(bd.person_guide,0) personGuide,
			bdp.booking_id,
			bdp.remark,
			bdp.item_name,
			bdp.num_person,
			bdp.num_times,
			bdp.unit_price,
			bdp.sale_price,
			bdp.total_price,
			tg.product_brand_name,
			tg.product_name
		FROM 
			booking_delivery_price bdp 
		INNER JOIN booking_delivery  bd ON bdp.booking_id=bd.id
		INNER JOIN tour_group tg ON tg.id=bd.group_id
		where tg.biz_id = #{bizId} and tg.group_state in (1,3,4)
		<if test="set!=null">
			AND tg.operator_id in
			<foreach item="item" index="index" collection="set" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>
		 <if test="page.parameter.startTime != null and page.parameter.startTime != ''" >
        	and tg.date_start <![CDATA[>=]]> #{page.parameter.startTime}	
      	 </if>
      	 <if test="page.parameter.endTime != null and page.parameter.endTime != ''" >
        	and tg.date_start <![CDATA[<=]]> #{page.parameter.endTime}	
      	 </if>
      	 <if test="page.parameter.groupCode != null and page.parameter.groupCode != ''" >
        	and tg.group_code LIKE CONCAT('%',#{page.parameter.groupCode},'%')	
      	 </if>
      	 <if test="page.parameter.supplierName != null and page.parameter.supplierName != ''" >
        	and bd.supplier_name LIKE CONCAT('%',#{page.parameter.supplierName},'%')		
      	 </if>
      	 <if test="page.parameter.itemName != null and page.parameter.itemName != ''" >
        	and bdp.item_name LIKE CONCAT('%',#{page.parameter.itemName},'%')
      	 </if>
      	 <if test="page.parameter.saleOperatorIds!= null and page.parameter.saleOperatorIds != ''" >
        	and tg.operator_id in (${page.parameter.saleOperatorIds})	
      	 </if>
		 <if test="page.parameter.groupMode == 0">and tg.group_mode <![CDATA[<]]> 1</if>
		 <if test="page.parameter.groupMode !=0 and page.parameter.groupMode!=null">and tg.group_mode <![CDATA[>]]>0</if>
		<if test="page.parameter.groupIds!=null and page.parameter.groupIds!=''">and tg.id in (${page.parameter.groupIds})</if>
		<if test="page.parameter.productName!=null and page.parameter.productName!=''">
			and (tg.product_brand_name LIKE CONCAT('%',#{page.parameter.productName},'%') or tg.product_name LIKE	CONCAT('%',#{page.parameter.productName},'%'))
		</if>
		ORDER BY tg.date_start,tg.create_time,bd.id
  </select>
<!--   <select id="getSupplierPriceTotalPerson" resultType="java.util.HashMap" parameterType="com.yihg.mybatis.utility.PageBean"  >
    	select sum(personAdult) personAdult,sum(personChild) personChild,sum(personGuide) personGuide from (
    	SELECT 
			
			IFNULL(bd.person_adult,0) personAdult,
			IFNULL(bd.person_child,0) personChild,
			IFNULL(bd.person_guide,0) personGuide
			
		FROM 
			booking_delivery_price bdp 
		INNER JOIN booking_delivery  bd ON bdp.booking_id=bd.id
		INNER JOIN tour_group tg ON tg.id=bd.group_id
		where tg.biz_id = #{bizId} and tg.group_state in (1,3,4)
		<if test="set!=null">
			AND tg.operator_id in
			<foreach item="item" index="index" collection="set" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>
		 <if test="page.parameter.startTime != null and page.parameter.startTime != ''" >
        	and tg.date_start <![CDATA[>=]]> #{page.parameter.startTime}	
      	 </if>
      	 <if test="page.parameter.endTime != null and page.parameter.endTime != ''" >
        	and tg.date_start <![CDATA[<=]]> #{page.parameter.endTime}	
      	 </if>
      	 <if test="page.parameter.groupCode != null and page.parameter.groupCode != ''" >
        	and tg.group_code LIKE CONCAT('%',#{page.parameter.groupCode},'%')	
      	 </if>
      	 <if test="page.parameter.supplierName != null and page.parameter.supplierName != ''" >
        	and bd.supplier_name LIKE CONCAT('%',#{page.parameter.supplierName},'%')		
      	 </if>
      	 <if test="page.parameter.itemName != null and page.parameter.itemName != ''" >
        	and bdp.item_name LIKE CONCAT('%',#{page.parameter.itemName},'%')
      	 </if>
      	 <if test="page.parameter.saleOperatorIds!= null and page.parameter.saleOperatorIds != ''" >
        	and tg.operator_id in (${page.parameter.saleOperatorIds})	
      	 </if>
		 <if test="page.parameter.groupMode == 0">and tg.group_mode <![CDATA[<]]> 1</if>
		 <if test="page.parameter.groupMode !=0 and page.parameter.groupMode!=null">and tg.group_mode <![CDATA[>]]>0</if>
		<if test="page.parameter.groupIds!=null and page.parameter.groupIds!=''">and tg.id in (${page.parameter.groupIds})</if>
		ORDER BY tg.date_start,tg.create_time,bd.id ) t
  </select> -->
  <select id="getSupplierPriceTotal" resultType="java.util.HashMap" parameterType="com.yihg.mybatis.utility.PageBean">
    	SELECT 
			sum(bdp.total_price) totals,sum(IFNULL(bd.person_adult,0)) personAdult,sum(IFNULL(bd.person_child,0)) personChild,sum(IFNULL(bd.person_guide,0)) personGuide
		FROM 
			booking_delivery_price bdp 
		INNER JOIN booking_delivery  bd ON bdp.booking_id=bd.id
		INNER JOIN tour_group tg ON tg.id=bd.group_id
		where tg.biz_id = #{bizId}  and tg.group_state in (1,3,4)
		<if test="set!=null">
			AND tg.operator_id in
			<foreach item="item" index="index" collection="set" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>
		 <if test="page.parameter.startTime != null and page.parameter.startTime != ''" >
        	and tg.date_start <![CDATA[>=]]> #{page.parameter.startTime}	
      	 </if>
      	 <if test="page.parameter.endTime != null and page.parameter.endTime != ''" >
        	and tg.date_start <![CDATA[<=]]> #{page.parameter.endTime}	
      	 </if>
      	 <if test="page.parameter.groupCode != null and page.parameter.groupCode != ''" >
        	and tg.group_code LIKE CONCAT('%',#{page.parameter.groupCode},'%')	
      	 </if>
      	 <if test="page.parameter.supplierName != null and page.parameter.supplierName != ''" >
        	and bd.supplier_name LIKE CONCAT('%',#{page.parameter.supplierName},'%')		
      	 </if>
      	 <if test="page.parameter.itemName != null and page.parameter.itemName != ''" >
        	and bdp.item_name LIKE CONCAT('%',#{page.parameter.itemName},'%')
      	 </if>
      	 <if test="page.parameter.saleOperatorIds != null and page.parameter.saleOperatorIds != ''" >
        	and tg.operator_id in (${page.parameter.saleOperatorIds})	
      	 </if>
      	 <if test="page.parameter.productName!=null and page.parameter.productName!=''">
			and (tg.product_brand_name LIKE CONCAT('%',#{page.parameter.productName},'%') or tg.product_name LIKE	CONCAT('%',#{page.parameter.productName},'%'))
		</if>
      	 <!-- <if test="page.parameter.groupMode == null">and tg.group_mode <![CDATA[>]]> -1</if>
		  -->
		  <if test="page.parameter.groupIds!=null and page.parameter.groupIds!=''">and tg.id in (${page.parameter.groupIds})</if>
		  <if test="page.parameter.groupMode == 0">and tg.group_mode <![CDATA[<]]> 1</if>
		 <if test="page.parameter.groupMode !=0 and page.parameter.groupMode!=null">and tg.group_mode <![CDATA[>]]>0</if>
  </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from booking_delivery_price
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    delete from booking_delivery_price
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.yimayhd.erpcenter.dal.sales.client.operation.po.BookingDeliveryPrice" >
    insert into booking_delivery_price (id, booking_id, item_name, 
      remark, unit_price,sale_price, num_times,
      num_person, total_price, row_state, 
      creator_id, creator_name, create_time
      )
    values (#{id,jdbcType=INTEGER}, #{bookingId,jdbcType=INTEGER}, #{itemName,jdbcType=VARCHAR}, 
      #{remark,jdbcType=VARCHAR}, #{unitPrice,jdbcType=DECIMAL}, #{salePrice,jdbcType=DECIMAL},#{numTimes,jdbcType=DECIMAL},
      #{numPerson,jdbcType=DECIMAL}, #{totalPrice,jdbcType=DECIMAL}, #{rowState,jdbcType=TINYINT}, 
      #{creatorId,jdbcType=INTEGER}, #{creatorName,jdbcType=VARCHAR}, #{createTime,jdbcType=BIGINT}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.yimayhd.erpcenter.dal.sales.client.operation.po.BookingDeliveryPrice" >
    insert into booking_delivery_price
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="bookingId != null" >
        booking_id,
      </if>
      <if test="itemName != null" >
        item_name,
      </if>
      <if test="remark != null" >
        remark,
      </if>
      <if test="unitPrice != null" >
        unit_price,
      </if>
      <if test="salePrice != null" >
        sale_price,
      </if>
      <if test="numTimes != null" >
        num_times,
      </if>
      <if test="numPerson != null" >
        num_person,
      </if>
      <if test="totalPrice != null" >
        total_price,
      </if>
      <if test="rowState != null" >
        row_state,
      </if>
      <if test="creatorId != null" >
        creator_id,
      </if>
      <if test="creatorName != null" >
        creator_name,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="bookingId != null" >
        #{bookingId,jdbcType=INTEGER},
      </if>
      <if test="itemName != null" >
        #{itemName,jdbcType=VARCHAR},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="unitPrice != null" >
        #{unitPrice,jdbcType=DECIMAL},
      </if>
      <if test="numTimes != null" >
        #{numTimes,jdbcType=DECIMAL},
      </if>
      <if test="numPerson != null" >
        #{numPerson,jdbcType=DECIMAL},
      </if>
      <if test="totalPrice != null" >
        #{totalPrice,jdbcType=DECIMAL},
      </if>
      <if test="rowState != null" >
        #{rowState,jdbcType=TINYINT},
      </if>
      <if test="creatorId != null" >
        #{creatorId,jdbcType=INTEGER},
      </if>
      <if test="creatorName != null" >
        #{creatorName,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.yimayhd.erpcenter.dal.sales.client.operation.po.BookingDeliveryPrice" >
    update booking_delivery_price
    <set >
      <if test="bookingId != null" >
        booking_id = #{bookingId,jdbcType=INTEGER},
      </if>
      <if test="itemName != null" >
        item_name = #{itemName,jdbcType=VARCHAR},
      </if>
      <if test="remark != null" >
        remark = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="unitPrice != null" >
        unit_price = #{unitPrice,jdbcType=DECIMAL},
      </if>
      <if test="salePrice != null" >
        sale_price = #{salePrice,jdbcType=DECIMAL},
      </if>
      <if test="numTimes != null" >
        num_times = #{numTimes,jdbcType=DECIMAL},
      </if>
      <if test="numPerson != null" >
        num_person = #{numPerson,jdbcType=DECIMAL},
      </if>
      <if test="totalPrice != null" >
        total_price = #{totalPrice,jdbcType=DECIMAL},
      </if>
      <if test="rowState != null" >
        row_state = #{rowState,jdbcType=TINYINT},
      </if>
      <if test="creatorId != null" >
        creator_id = #{creatorId,jdbcType=INTEGER},
      </if>
      <if test="creatorName != null" >
        creator_name = #{creatorName,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.yimayhd.erpcenter.dal.sales.client.operation.po.BookingDeliveryPrice" >
    update booking_delivery_price
    set booking_id = #{bookingId,jdbcType=INTEGER},
      item_name = #{itemName,jdbcType=VARCHAR},
      remark = #{remark,jdbcType=VARCHAR},
      unit_price = #{unitPrice,jdbcType=DECIMAL},
      sale_price = #{salePrice,jdbcType=DECIMAL},
      num_times = #{numTimes,jdbcType=DECIMAL},
      num_person = #{numPerson,jdbcType=DECIMAL},
      total_price = #{totalPrice,jdbcType=DECIMAL},
      row_state = #{rowState,jdbcType=TINYINT},
      creator_id = #{creatorId,jdbcType=INTEGER},
      creator_name = #{creatorName,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=BIGINT}
    where id = #{id,jdbcType=INTEGER}
  </update>
  <insert id="insertBatch" parameterType="java.util.List" >
    insert into booking_delivery_price (id, booking_id, item_name, 
      remark, unit_price,sale_price, num_times,
      num_person, total_price, row_state, 
      creator_id, creator_name, create_time)  
    values 
    <foreach collection="list" item="item" index="index" separator=",">
	    (#{item.id,jdbcType=INTEGER}, #{item.bookingId,jdbcType=INTEGER}, #{item.itemName,jdbcType=VARCHAR},
	    #{item.remark,jdbcType=VARCHAR},#{item.unitPrice,jdbcType=DECIMAL},#{item.salePrice,jdbcType=DECIMAL},#{item.numTimes,jdbcType=DECIMAL},
	    #{item.numPerson,jdbcType=DECIMAL},#{item.totalPrice,jdbcType=DECIMAL},#{item.rowState,jdbcType=TINYINT},
	    #{item.creatorId,jdbcType=INTEGER},#{item.creatorName,jdbcType=VARCHAR},#{item.createTime,jdbcType=BIGINT}
	    )    	
    </foreach>
  </insert>
  <delete id="deleteBatch" parameterType="java.util.List">
    delete from booking_delivery_price
    where id not in
    <foreach collection="list" item="item" open="(" separator="," close=")">
    	#{item.id,jdbcType=INTEGER}
    </foreach>   
    and booking_id=#{list[0].bookingId}
  </delete>
  <select id="getPriceListByBookingId" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from booking_delivery_price
    where booking_id = #{bookingId,jdbcType=INTEGER}
  </select>
  <update id="updateBatch" parameterType="java.util.List" >
  	<foreach collection="list" item="item" index="index" open="" close="" separator=";">
	    update booking_delivery_price
	    <set >
	      <if test="item.bookingId != null" >
	        booking_id = #{item.bookingId,jdbcType=INTEGER},
	      </if>
	      <if test="item.itemName != null" >
	        item_name = #{item.itemName,jdbcType=VARCHAR},
	      </if>
	      <if test="item.remark!= null" >
	        remark = #{item.remark,jdbcType=VARCHAR},
	      </if>
	      <if test="item.remark == null" >
	        remark = '',
	      </if>
	      <if test="item.unitPrice != null" >
	        unit_price = #{item.unitPrice,jdbcType=DECIMAL},
	      </if>
	      <if test="item.salePrice != null" >
	        sale_price = #{item.salePrice,jdbcType=DECIMAL},
	      </if>
	      <if test="item.numTimes!= null" >
	        num_times = #{item.numTimes,jdbcType=DECIMAL},
	      </if>
	      <if test="item.numPerson!= null" >
	        num_person = #{item.numPerson,jdbcType=DECIMAL},
	      </if>
	      <if test="item.totalPrice != null" >
	        total_price = #{item.totalPrice,jdbcType=DECIMAL},
	      </if>
	      <if test="item.rowState != null" >
	        row_state = #{item.rowState,jdbcType=TINYINT},
	      </if>	      
	    </set>
	    where id = #{item.id,jdbcType=INTEGER}  		 		
  	</foreach>
  </update>
  <delete id="deleteByBookingId" parameterType="java.lang.Integer" >
    delete from booking_delivery_price
    where booking_id = #{bookingId,jdbcType=INTEGER}
  </delete>
</mapper>