<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yimayhd.sales.mapper.AirTicketRequestMapper" >
  <resultMap id="BaseResultMap" type="com.yimayhd.erpcenter.dal.sales.client.airticket.po.AirTicketRequest" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="biz_id" property="bizId" jdbcType="INTEGER" />
    <result column="resource_id" property="resourceId" jdbcType="INTEGER" />
    <result column="resource_number" property="resourceNumber" jdbcType="VARCHAR" />
    <result column="group_order_id" property="groupOrderId" jdbcType="INTEGER" />
    <result column="status" property="status" jdbcType="VARCHAR" />
    <result column="is_del" property="isDel" jdbcType="CHAR" />
    <result column="creater_id" property="createrId" jdbcType="INTEGER" />
    <result column="creater_name" property="createrName" jdbcType="VARCHAR" />
    <result column="operator_id" property="operatorId" jdbcType="INTEGER" />
    <result column="operator_name" property="operatorName" jdbcType="VARCHAR" />
    <result column="add_time" property="addTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="comment" property="comment" jdbcType="VARCHAR" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="payment_type" property="paymentType" jdbcType="VARCHAR" />
    <result column="booking_supplier_id" property="bookingSupplierId" jdbcType="INTEGER"/>
    <result column="guest_number" property="guestNumber" jdbcType="INTEGER"/>
  </resultMap>
  <sql id="Base_Column_List" >
    id, biz_id, resource_id, resource_number, group_order_id, status, booking_supplier_id, is_del, creater_id, 
    creater_name, operator_id, operator_name, add_time, update_time, comment, remark, payment_type, guest_number
  </sql>
  <sql id="Base_Column_List_a" >
    a.id, a.biz_id, a.resource_id, a.resource_number, a.group_order_id, a.status, a.booking_supplier_id, a.is_del, 
    a.creater_id, a.creater_name, a.operator_id, a.operator_name, a.add_time, a.update_time, a.comment, a.remark, a.payment_type, a.guest_number
  </sql>
  
  
  <!--  单条插入  -->
  <insert id="insert"  parameterType="com.yimayhd.erpcenter.dal.sales.client.airticket.po.AirTicketRequest"  useGeneratedKeys="true" keyProperty="id">
    insert into air_ticket_request
    <trim prefix="(" suffix=")" suffixOverrides="," >
        biz_id, resource_id, is_del,
      <if test="resourceNumber != null" > resource_number, </if> 
      <if test="groupOrderId != null" > group_order_id, </if>
      <if test="status != null" > status,</if>
      <if test="createrId != null" > creater_id, </if>
      <if test="createrName != null" >creater_name,</if>
      <if test="comment != null" >comment,</if>
      <if test="paymentType != null" >payment_type,</if>
      <if test="guestNumber !=null">guest_number</if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
        #{bizId,jdbcType=INTEGER}, #{resourceId,jdbcType=INTEGER}, 'N',
      <if test="resourceNumber != null" >#{resourceNumber,jdbcType=VARCHAR},</if>
      <if test="groupOrderId != null" >#{groupOrderId,jdbcType=INTEGER},</if>
      <if test="status != null " >#{status,jdbcType=VARCHAR},</if>
      <if test="createrId != null" >#{createrId,jdbcType=INTEGER},</if>
      <if test="createrName != null" >#{createrName,jdbcType=VARCHAR},</if>
      <if test="comment != null" >#{comment,jdbcType=VARCHAR},</if>
      <if test="paymentType != null" >#{paymentType,jdbcType=VARCHAR},</if>
      <if test="guestNumber != null" >#{guestNumber,jdbcType=INTEGER},</if>
      </trim>
  </insert>
  
  
  <update id="setStatus">
   update air_ticket_request 
   <set>
    `status`=#{param.status, jdbcType=VARCHAR} , operator_id=#{param.opId, jdbcType=INTEGER},
   operator_name=#{param.opName, jdbcType=VARCHAR}, update_time=now(),
   `comment`=concat(`comment`, "\n", #{param.opLog, jdbcType=VARCHAR}),
   <if test="param.remark!=null">
   	<if test="param.remark != ''.toString()" >`remark`=#{param.remark},</if>
   </if>
   </set>
   where id= #{param.requestId,jdbcType=INTEGER} and biz_id = #{param.bizId,jdbcType=INTEGER}
  </update>
  
  <update id="updateBookingSupplierId">
  update air_ticket_request set booking_supplier_id=#{bookingSupplierId, jdbcType=INTEGER}
  where  id= #{id,jdbcType=INTEGER} and biz_id = #{bizId,jdbcType=INTEGER}
  </update>
  
  <!-- 逻辑删除 -->
  <update id="delete">
  	update air_ticket_request set is_del = 'Y', operator_id=#{opId, jdbcType=INTEGER},
   operator_name=#{opName, jdbcType=VARCHAR}, guest_number=0,
   `comment`=concat(`comment`, "\n", #{comment, jdbcType=VARCHAR})
  	where id = #{id,jdbcType=INTEGER} and biz_id = #{bizId,jdbcType=INTEGER}
  </update>
  
  <!-- 取得resource下的request数  -->
  <select id="countRequestByResource" resultType="int">
    select count(*) from air_ticket_request where is_del='N' and biz_id=#{bizId,jdbcType=INTEGER} and resource_id=#{resourceId,jdbcType=INTEGER}
  </select>
  <select id="selectRequestIdByOrderId" resultType="Integer">
    select id from air_ticket_request where is_del='N' and biz_id=#{bizId,jdbcType=INTEGER} and group_order_id=#{orderId,jdbcType=INTEGER} order by id desc limit 1;
  </select>
  
    <select id="selectRequestIdByBKId" resultType="Integer">
    select count(*) from air_ticket_request where booking_supplier_id=#{bookingSupplierId,jdbcType=INTEGER}
  </select>
  
  <!-- 更新 -->
  <update id="update" parameterType="com.yimayhd.erpcenter.dal.sales.client.airticket.po.AirTicketRequest" >
    update air_ticket_request
    <set >
      <if test="resourceId != null" >
        resource_id = #{resourceId,jdbcType=INTEGER},
      </if>
      <if test="resourceNumber != null and resourceNumber != ''" >
        resource_number = #{resourceNumber,jdbcType=VARCHAR},
      </if>
      <if test="groupOrderId != null" >
        group_order_id = #{groupOrderId,jdbcType=INTEGER},
      </if>
      <if test="status != null and status != ''" >
        status = #{status,jdbcType=VARCHAR},
      </if>
      <if test="isDel != null and isDel != ''" >
        is_del = #{isDel,jdbcType=CHAR},
      </if>
      <if test="operatorId != null" >
        operator_id = #{operatorId,jdbcType=INTEGER},
      </if>
      <if test="operatorName != null and operatorName != ''" >
        operator_name = #{operatorName,jdbcType=VARCHAR},
      </if>
      
        update_time = current_time(),
        
      <if test="comment != null and comment != ''" >
        comment = concat(`comment`, #{comment,jdbcType=VARCHAR}),
      </if>
      <if test="paymentType != null and paymentType != ''" >payment_type = #{paymentType,jdbcType=VARCHAR},</if>
      <if test="guestNumber != null">guest_number=#{guestNumber,jdbcType=INTEGER}</if>
    </set>
    where id = #{id,jdbcType=INTEGER} and biz_id = #{bizId,jdbcType=INTEGER}
  </update>
  
    <!-- 单条查询 -->
  <select id="findRequest" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from air_ticket_request
    where id = #{id,jdbcType=INTEGER} and biz_id = #{bizId,jdbcType=INTEGER} and is_del = 'N'
  </select>
  
  
   <!-- 分页查询 -->
   <select id="selectRequestListPage" resultMap="BaseResultMap" parameterType="com.yihg.mybatis.utility.PageBean" >
    select 
    <include refid="Base_Column_List" />
    from air_ticket_request
    where biz_id = #{parameter.bizId,jdbcType=INTEGER} and is_del = 'N'
    order by update_time 
  </select>
  
  <select id="selectRequestListPageWithGroupOrder" resultMap="BaseResultMap" parameterType="com.yihg.mybatis.utility.PageBean" >
    SELECT <include refid="Base_Column_List_a" /> FROM air_ticket_request a 
    JOIN group_order o ON a.group_order_id=o.id
    JOIN air_ticket_resource r on a.resource_id=r.id
    where a.biz_id = #{parameter.bizId,jdbcType=INTEGER} and a.is_del = 'N'
    <if test="parameter.dataUser != null">
    	and o.operator_id in (${parameter.dataUser})
    </if>
    <if test="parameter.dateType!=null">
    	<if test="parameter.dateType == 'order'">
		    <if test="parameter.dateFrom != null and parameter.dateFrom != ''">
		    	and o.departure_date <![CDATA[>=]]> #{parameter.dateFrom}
		    </if>
		    <if test="parameter.dateTo != null and parameter.dateTo != ''">
		    	and o.departure_date <![CDATA[<=]]> #{parameter.dateTo}
		    </if>
    	</if>
    	<if test="parameter.dateType == 'start'">
		    <if test="parameter.dateFrom != null and parameter.dateFrom != ''">
		    	and r.start_date <![CDATA[>=]]> #{parameter.dateFrom}
		    </if>
		    <if test="parameter.dateTo != null and parameter.dateTo != ''">
		    	and r.start_date <![CDATA[<=]]> #{parameter.dateTo}
		    </if>
    	</if>
    	
    	<if test="parameter.dateType == 'dep'">
		    <if test="parameter.dateFrom != null and parameter.dateFrom != ''">
		    	and r.dep_date <![CDATA[>=]]> #{parameter.dateFrom}
		    </if>
		    <if test="parameter.dateTo != null and parameter.dateTo != ''">
		    	and r.dep_date <![CDATA[<=]]> #{parameter.dateTo}
		    </if>
    	</if>
    </if>
    <if test="parameter.endIssueTimeFrom">
    	and r.end_issue_time <![CDATA[>=]]> #{parameter.endIssueTimeFrom}
    </if>
    <if test="parameter.endIssueTimeTo">
    	and r.end_issue_time <![CDATA[<=]]> #{parameter.endIssueTimeTo}
    </if>
    <if test="parameter.type!=null and parameter.type!=''">
		and r.type = #{parameter.type}
    </if>
    <if test="parameter.productName != null and parameter.productName != ''">
    	and (o.product_brand_name like concat('%',#{parameter.productName},'%') 
    		or o.product_name like concat('%',#{parameter.productName},'%') )
    </if>
    <if test="parameter.orderNo != null and parameter.orderNo != ''">
    	and o.order_no like concat  ('%',#{parameter.orderNo},'%')
    </if>
    <if test="parameter.contactName != null and parameter.contactName != ''">
    	and o.creater_name like concat('%',#{parameter.contactName},'%')
    </if>
	<if test="parameter.receiveMode != null and parameter.receiveMode!=''">
    	and o.receive_mode like concat('%',#{parameter.receiveMode},'%')
    </if>
	<if test="parameter.lineName != null and parameter.lineName != ''">
    	and r.line_name like concat('%',#{parameter.lineName},'%')
    </if>
    <if test="parameter.saleName != null and parameter.saleName != ''">
    	and o.sale_operator_name like concat('%',#{parameter.saleName},'%')
    </if>
	<if test="parameter.depCity != null and parameter.depCity != ''">
    	and r.dep_city like concat('%',#{parameter.depCity},'%')
    </if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'ARRANGING'.toString()">
    	and a.status='ARRANGING'
    </if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'CONFIRMING'.toString()">
    	and a.status='CONFIRMING'
    </if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'REJECTED'.toString()">
    	and a.status='REJECTED'
    </if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'ISSUING'.toString()">
    	and a.status='ISSUING'
    </if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'ISSUED'.toString()">
    	and a.status='ISSUED'
    </if>
    order by o.departure_date, create_time 
  </select>
  
  <select id="countAppliedTickets" resultType="java.util.HashMap">
 	SELECT SUM(a.`guest_number`) applied
	FROM air_ticket_request a join air_ticket_resource r on r.id=a.resource_id
	JOIN group_order o ON a.group_order_id=o.id
	where a.biz_id = #{parameter.bizId,jdbcType=INTEGER} and a.is_del = 'N'
    <if test="parameter.dataUser != null">
    	and o.operator_id in (${parameter.dataUser})
    </if>
    <if test="parameter.dateType!=null">
    	<if test="parameter.dateType == 'order'">
		    <if test="parameter.dateFrom != null and parameter.dateFrom != ''">and o.departure_date <![CDATA[>=]]> #{parameter.dateFrom}</if>
		    <if test="parameter.dateTo != null and parameter.dateTo != ''">and o.departure_date <![CDATA[<=]]> #{parameter.dateTo}</if>
    	</if>
    	<if test="parameter.dateType == 'start'">
		    <if test="parameter.dateFrom != null and parameter.dateFrom != ''">and r.start_date <![CDATA[>=]]> #{parameter.dateFrom}</if>
		    <if test="parameter.dateTo != null and parameter.dateTo != ''">and r.start_date <![CDATA[<=]]> #{parameter.dateTo}</if>
    	</if>
    	<if test="parameter.dateType == 'dep'">
		    <if test="parameter.dateFrom != null and parameter.dateFrom != ''">and r.dep_date <![CDATA[>=]]> #{parameter.dateFrom}</if>
		    <if test="parameter.dateTo != null and parameter.dateTo != ''">and r.dep_date <![CDATA[<=]]> #{parameter.dateTo}</if>
    	</if>
    </if>
    <if test="parameter.endIssueTimeFrom">and r.end_issue_time <![CDATA[>=]]> #{parameter.endIssueTimeFrom}</if>
    <if test="parameter.endIssueTimeTo">and r.end_issue_time <![CDATA[<=]]> #{parameter.endIssueTimeTo}</if>
    <if test="parameter.type!=null and parameter.type!=''">and r.type = #{parameter.type}</if>
    <if test="parameter.productName != null and parameter.productName != ''">and (o.product_brand_name like concat('%',#{parameter.productName},'%') or o.product_name like concat('%',#{parameter.productName},'%') )</if>
    <if test="parameter.orderNo != null and parameter.orderNo != ''">and o.order_no like concat  ('%',#{parameter.orderNo},'%')</if>
    <if test="parameter.contactName != null and parameter.contactName != ''">and o.creater_name like concat('%',#{parameter.contactName},'%')</if>
	<if test="parameter.receiveMode != null and parameter.receiveMode!=''">and o.receive_mode like concat('%',#{parameter.receiveMode},'%')</if>
	<if test="parameter.lineName != null and parameter.lineName != ''">and r.line_name like concat('%',#{parameter.lineName},'%')</if>
	<if test="parameter.saleName != null and parameter.saleName != ''">and o.sale_operator_name like concat('%',#{parameter.saleName},'%')</if>
	<if test="parameter.depCity != null and parameter.depCity != ''">and r.dep_city like concat('%',#{parameter.depCity},'%')</if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'ARRANGING'.toString()">and a.status='ARRANGING'</if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'CONFIRMING'.toString()">and a.status='CONFIRMING'</if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'REJECTED'.toString()">and a.status='REJECTED'</if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'ISSUING'.toString()">and a.status='ISSUING'</if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'ISSUED'.toString()">and a.status='ISSUED'</if>
  </select>
 
  <select id="countAvailableTickets" resultType="java.util.HashMap">

	SELECT SUM(r.total_number) total, SUM(r.total_number)- SUM(r.applied_number) available FROM air_ticket_resource r 
	 WHERE r.id IN 
	(SELECT DISTINCT a.resource_id rid
	FROM air_ticket_request a join air_ticket_resource r on r.id=a.resource_id
	JOIN group_order o ON a.group_order_id=o.id
	where a.biz_id = #{parameter.bizId,jdbcType=INTEGER} and a.is_del = 'N'
    <if test="parameter.dataUser != null">
    	and o.operator_id in (${parameter.dataUser})
    </if>
    <if test="parameter.dateType!=null">
    	<if test="parameter.dateType == 'order'">
		    <if test="parameter.dateFrom != null and parameter.dateFrom != ''">and o.departure_date <![CDATA[>=]]> #{parameter.dateFrom}</if>
		    <if test="parameter.dateTo != null and parameter.dateTo != ''">and o.departure_date <![CDATA[<=]]> #{parameter.dateTo}</if>
    	</if>
    	<if test="parameter.dateType == 'start'">
		    <if test="parameter.dateFrom != null and parameter.dateFrom != ''">and r.start_date <![CDATA[>=]]> #{parameter.dateFrom}</if>
		    <if test="parameter.dateTo != null and parameter.dateTo != ''">and r.start_date <![CDATA[<=]]> #{parameter.dateTo}</if>
    	</if>
    	<if test="parameter.dateType == 'dep'">
		    <if test="parameter.dateFrom != null and parameter.dateFrom != ''">and r.dep_date <![CDATA[>=]]> #{parameter.dateFrom}</if>
		    <if test="parameter.dateTo != null and parameter.dateTo != ''">and r.dep_date <![CDATA[<=]]> #{parameter.dateTo}</if>
    	</if>
    </if>
    <if test="parameter.endIssueTimeFrom">and r.end_issue_time <![CDATA[>=]]> #{parameter.endIssueTimeFrom}</if>
    <if test="parameter.endIssueTimeTo">and r.end_issue_time <![CDATA[<=]]> #{parameter.endIssueTimeTo}</if>
    <if test="parameter.type!=null and parameter.type!=''">and r.type = #{parameter.type}</if>
    <if test="parameter.productName != null and parameter.productName != ''">and (o.product_brand_name like concat('%',#{parameter.productName},'%') or o.product_name like concat('%',#{parameter.productName},'%') )</if>
    <if test="parameter.orderNo != null and parameter.orderNo != ''">and o.order_no like concat  ('%',#{parameter.orderNo},'%')</if>
    <if test="parameter.contactName != null and parameter.contactName != ''">and o.creater_name like concat('%',#{parameter.contactName},'%')</if>
	<if test="parameter.receiveMode != null and parameter.receiveMode!=''">and o.receive_mode like concat('%',#{parameter.receiveMode},'%')</if>
	<if test="parameter.lineName != null and parameter.lineName != ''">and r.line_name like concat('%',#{parameter.lineName},'%')</if>
	<if test="parameter.saleName != null and parameter.saleName != ''">and o.sale_operator_name like concat('%',#{parameter.saleName},'%')</if>
	<if test="parameter.depCity != null and parameter.depCity != ''">and r.dep_city like concat('%',#{parameter.depCity},'%')</if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'ARRANGING'.toString()">and a.status='ARRANGING'</if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'CONFIRMING'.toString()">and a.status='CONFIRMING'</if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'REJECTED'.toString()">and a.status='REJECTED'</if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'ISSUING'.toString()">and a.status='ISSUING'</if>
	<if test="parameter.issueStatus != null and parameter.issueStatus == 'ISSUED'.toString()">and a.status='ISSUED'</if>
	) 
  </select>


  
  <select id="findRequestsByResource" resultType="java.lang.Integer">
    select id from air_ticket_request
    where resource_id = #{id,jdbcType=INTEGER} and biz_id = #{bizId,jdbcType=INTEGER} and is_del = 'N'
  </select>
  <select id="findRequestsByGroupOrderId" resultMap="BaseResultMap" >
    select <include refid="Base_Column_List" />
    from air_ticket_request
    where biz_id = #{bizId,jdbcType=INTEGER} and is_del = 'N' and group_order_id in (${strOrderIds})
  </select>
  
  
</mapper>