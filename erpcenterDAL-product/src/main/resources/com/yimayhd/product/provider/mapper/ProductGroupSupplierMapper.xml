<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yihg.product.dao.ProductGroupSupplierMapper" >
  <resultMap id="BaseResultMap" type="com.yihg.product.po.ProductGroupSupplier" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="group_id" property="groupId" jdbcType="INTEGER" />
    <result column="product_id" property="productId" jdbcType="INTEGER" />
    <result column="supplier_id" property="supplierId" jdbcType="INTEGER" />
    <result column="supplier_name" property="supplierName" jdbcType="VARCHAR" />
    <result column="province" property="province" jdbcType="VARCHAR" />
    <result column="city" property="city" jdbcType="VARCHAR" />
    <result column="area" property="area" jdbcType="VARCHAR" />
    <result column="town" property="town" jdbcType="VARCHAR" />
    <result column="state" property="state" jdbcType="TINYINT" />
    <result column="create_time" property="createTime" jdbcType="BIGINT" />
    <result column="update_time" property="updateTime" jdbcType="DATE" />
    <collection property="productGroupList" ofType="com.yihg.product.po.ProductGroup"   >
    	<id property="id"  column="productGroupId"/>
    	<result column="name" property="name" jdbcType="VARCHAR" />
    	<collection property="groupPrices" ofType="com.yihg.product.po.ProductGroupPrice"  column="productGroupId" >
    		<id column="groupPriceId" property="id" jdbcType="INTEGER" />
		    <result column="group_date" property="groupDate" jdbcType="DATE" />
		    <result column="group_date_to" property="groupDateTo" jdbcType="DATE" />
		    <result column="price_settlement_adult" property="priceSettlementAdult" jdbcType="REAL" />
		    <result column="price_settlement_child" property="priceSettlementChild" jdbcType="REAL" />
		
		    <result column="price_cost_adult" property="priceCostAdult" jdbcType="REAL" />
		    <result column="price_cost_child" property="priceCostChild" jdbcType="REAL" />
    	</collection>
    </collection>
  </resultMap>
    <resultMap id="VoResultMap" type="com.yihg.product.vo.ProductGroupSupplierVo" >
        <id column="id" property="id" jdbcType="INTEGER" />
        <result column="group_id" property="groupId" jdbcType="INTEGER" />
        <result column="supplier_id" property="supplierId" jdbcType="INTEGER" />
        <result column="supplier_name" property="supplierName" jdbcType="VARCHAR" />
        <result column="province" property="province" jdbcType="VARCHAR" />
        <result column="city" property="city" jdbcType="VARCHAR" />
        <result column="area" property="area" jdbcType="VARCHAR" />
        <result column="town" property="town" jdbcType="VARCHAR" />
        <result column="state" property="state" jdbcType="TINYINT" />
        <result column="create_time" property="createTime" jdbcType="BIGINT" />
        <result column="stock" property="stock" jdbcType="INTEGER" />
    </resultMap>
  <sql id="Base_Column_List" >
    id,group_id,product_id, supplier_id,supplier_name,province,city,area,town, state,create_time,update_time
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from product_group_supplier
    where group_id = #{groupId,jdbcType=INTEGER}
  </select>
  <select id="selectProductGroupSuppliers" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from product_group_supplier
    where group_id = #{groupId,jdbcType=INTEGER}
    and state !=-1
    ORDER BY create_time DESC
  </select>
  <select id="selectProductGroupSupplierVos" resultMap="VoResultMap" parameterType="java.lang.Integer" >
    select
    p.id,p.group_id, p.supplier_id,p.supplier_name,p.province,p.city,p.area,p.town, p.state,p.create_time, IFNULL(s.stock_num, -1) stock
    from product_group_supplier p left join (SELECT s.supplier_id, s.stock_num FROM product_group_price_stockallocate s WHERE s.price_id = #{priceId,jdbcType=INTEGER}) s on p.supplier_id=s.supplier_id
    where p.group_id = #{groupId,jdbcType=INTEGER}
      and p.state !=-1
    ORDER BY p.create_time DESC
  </select>
   <select id="selectProductGroupSupplierVosToSales" resultMap="VoResultMap" parameterType="java.lang.Integer" >
    select
    p.id,p.group_id, p.supplier_id,p.supplier_name,p.province,p.city,p.area,p.town, p.state,p.create_time, IFNULL(s.stock_num, -1) stock
    from product_group_supplier p left join (SELECT s.supplier_id, s.stock_num FROM product_group_price_stockallocate s WHERE s.price_id = #{priceId,jdbcType=INTEGER}) s on p.supplier_id=s.supplier_id
    where p.group_id = #{groupId,jdbcType=INTEGER}
      and p.state !=-1
      and p.supplier_id =#{supplierId,jdbcType=INTEGER}
    ORDER BY p.create_time DESC
  </select>
  <select id="selectProductGroupSupplierListPage" resultMap="BaseResultMap" parameterType="com.yihg.mybatis.utility.PageBean">
    select
    <include refid="Base_Column_List" />
    from product_group_supplier
    where group_id = #{groupId,jdbcType=INTEGER}
    and state !=-1
    ORDER BY create_time DESC
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    delete from product_group_supplier
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.yihg.product.po.ProductGroupSupplier" >
    insert into product_group_supplier (group_id, supplier_id, create_time
      )
    values (#{groupId,jdbcType=INTEGER}, #{supplierId,jdbcType=INTEGER}, #{createTime,jdbcType=BIGINT}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.yihg.product.po.ProductGroupSupplier" >
  <selectKey resultType="java.lang.Integer" keyProperty="id" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into product_group_supplier
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="groupId != null" >
        group_id,
      </if>
      <if test="productId != null" >
        product_id,
      </if>
      <if test="supplierId != null" >
        supplier_id,
      </if>
       <if test="supplierName != null" >
        supplier_name,
      </if>
      <if test="province != null" >
        province,
      </if>
      <if test="city != null" >
        city,
      </if>
      <if test="area != null" >
        area,
      </if>
      <if test="town != null" >
        town,
      </if>
      <if test="state != null" >
        state,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="groupId != null" >
        #{groupId,jdbcType=INTEGER},
      </if>
      <if test="productId != null" >
        #{productId,jdbcType=INTEGER},
      </if>
      <if test="supplierId != null" >
        #{supplierId,jdbcType=INTEGER},
      </if>
      <if test="supplierName != null" >
        #{supplierName,jdbcType=VARCHAR},
      </if>
      <if test="province != null" >
        #{province,jdbcType=VARCHAR},
      </if>
      <if test="city != null" >
        #{city,jdbcType=VARCHAR},
      </if>
      <if test="area != null" >
        #{area,jdbcType=VARCHAR},
      </if>
      <if test="town != null" >
        #{town,jdbcType=VARCHAR},
      </if>
      <if test="state != null" >
        #{state,jdbcType=TINYINT},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=BIGINT},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.yihg.product.po.ProductGroupSupplier" >
    update product_group_supplier
    <set >
      <if test="supplierId != null" >
        supplier_id = #{supplierId,jdbcType=INTEGER},
      </if>
      <if test="supplierName != null" >
        supplier_name = #{supplierName,jdbcType=INTEGER},
      </if>
      <if test="state != null" >
        state = #{state,jdbcType=INTEGER},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=BIGINT},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.yihg.product.po.ProductGroupSupplier" >
    update product_group_supplier
    set supplier_id = #{supplierId,jdbcType=INTEGER},
      create_time = #{createTime,jdbcType=BIGINT}
    where group_id = #{groupId,jdbcType=INTEGER}
  </update>
  <select id="selectProductGroupSupplierList" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from product_group_supplier
    where 1=1 
    <if test="productId!=null">
    and  product_id = #{productId,jdbcType=INTEGER}
     </if>
    and state !=-1
    ORDER BY create_time DESC
  </select>
  <select id="selectById" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
  	select 
    <include refid="Base_Column_List" />
    from product_group_supplier
    where 1=1 
    <if test="id!=null">
    and  id = #{id,jdbcType=INTEGER}
     </if>
    and state !=-1
  </select>
  <select id="copyProduct" statementType="PREPARED" parameterType="java.util.HashMap">
  	<![CDATA[ 
  	 call copyProduct(#{parameter.fromProductId,jdbcType=INTEGER,mode=IN},
  						#{parameter.toProductId,jdbcType=INTEGER,mode=IN})
  	]]>  
  </select>
  <select id="copyProductSuppliers" statementType="PREPARED" parameterType="java.util.HashMap">
  	<![CDATA[ 
  	 call copyProductSupplier(#{parameter.fromProductSupplierId,jdbcType=INTEGER,mode=IN},
  						#{parameter.toProductId,jdbcType=INTEGER,mode=IN})
  	]]>  
  </select>
  <select id="selectSupplierList" resultMap="BaseResultMap" parameterType="com.yihg.product.vo.ProductSupplierCondition">
    SELECT
    <include refid="Base_Column_List" />
    FROM product_group_supplier
    WHERE state=1 
    <if test="productId!=null">
    	AND product_id = #{productId,jdbcType=INTEGER}
    </if>
    <if test="supplierName!=null and supplierName!=''">
    	AND supplier_name LIKE CONCAT('%',#{supplierName},'%')
    </if>
    <if test="outSupplierId!=null">
    	AND supplier_id!=#{outSupplierId}
    </if>
    <if test="city!=null and city!=''">
    	AND ((province LIKE CONCAT('%',#{city},'%')) OR (city  LIKE CONCAT('%',#{city},'%')))
    </if>  
    ORDER BY create_time DESC
    <if test="pageSize!=null">
    	LIMIT 0,#{pageSize,jdbcType=INTEGER}
    </if>
  </select>
  <update id="updateTimeById">
  	UPDATE `product_group_supplier` SET `update_time`= NOW() WHERE id= #{id,jdbcType=INTEGER}
  </update>
  <select id="getProductPriceInfoList" resultMap="BaseResultMap">
  	
  	SELECT pgs.id, pgs.`province`,pgs.`city`,pg.id as productGroupId,pgp.id as groupPriceId, pgs.area,pgs.town , pgs.`supplier_name`,pgs.`update_time`,pg.`name`,pgp.`group_date`,pgp.`group_date_to`,pgp.`price_cost_adult`,
	pgp.`price_cost_child`,
	pgp.`price_settlement_adult`,pgp.`price_settlement_child`
	FROM product_group_supplier pgs  left JOIN product_group pg ON pgs.`id`=pg.`group_supplier_id` left JOIN product_group_price pgp ON pg.`id`=pgp.`group_id` 
	WHERE pgs.`product_id`=#{productId} and pgs.state!=-1 and pg.state!=-1 and pgp.state!=-1
  </select>
</mapper>